name: SSH Connection Debug
on: workflow_dispatch

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: System Information
        run: |
          echo "=== 系统信息 ==="
          uname -a
          echo "=== OpenSSH 版本 ==="
          ssh -V 2>&1
          echo "=== 系统OpenSSL版本 ==="
          openssl version
          
      - name: Write and Test SSH Key
        run: |
          echo "=== 写入密钥文件 ==="
          # 使用更安全的方式写入密钥（避免换行符问题）
          echo "${{ secrets.GOOD_KITTY_PRIVATE_KEY }}" | tr -d '\r' > /tmp/debug_key
          echo "" >> /tmp/debug_key
          
          echo "=== 检查密钥完整性 ==="
          echo "文件大小: $(wc -c < /tmp/debug_key) 字节"
          echo "行数: $(wc -l < /tmp/debug_key)"
          
          echo "=== 完整密钥结构 ==="
          cat -A /tmp/debug_key | head -20  # 显示不可见字符
          
          echo "=== 检查密钥类型 ==="
          file /tmp/debug_key
          
          echo "=== 使用不同方法检查密钥 ==="
          # 方法1: ssh-keygen
          echo "1. ssh-keygen 检查:"
          ssh-keygen -l -f /tmp/debug_key 2>&1 | head -5
          
          # 方法2: openssl
          echo -e "\n2. openssl 检查:"
          if grep -q "BEGIN RSA PRIVATE KEY" /tmp/debug_key; then
            echo "检测到 RSA 密钥"
            openssl rsa -in /tmp/debug_key -check -noout 2>&1 || echo "RSA 密钥检查失败"
          elif grep -q "BEGIN OPENSSH PRIVATE KEY" /tmp/debug_key; then
            echo "检测到 OpenSSH 密钥"
            # OpenSSH 格式密钥需要不同方法
            ssh-keygen -l -f /tmp/debug_key 2>&1
          elif grep -q "BEGIN EC PRIVATE KEY" /tmp/debug_key; then
            echo "检测到 EC 密钥"
            openssl ec -in /tmp/debug_key -check -noout 2>&1
          else
            echo "未知密钥格式"
          fi
          
          echo -e "\n3. 十六进制头部检查:"
          xxd /tmp/debug_key | head -5
          
      - name: Test Different SSH Options
        run: |
          # 准备测试环境
          mkdir -p ~/.ssh
          echo "${{ secrets.GOOD_KITTY_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/test_key
          echo "" >> ~/.ssh/test_key
          chmod 600 ~/.ssh/test_key
          
          echo "=== 测试各种SSH连接选项 ==="
          
          # 选项1: 基础测试
          echo -e "\n1. 基础测试:"
          ssh -o BatchMode=yes \
              -o ConnectTimeout=5 \
              -i ~/.ssh/test_key \
              ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} "echo '基础测试'" 2>&1 | head -20 || true
          
          # 选项2: 详细日志
          echo -e "\n2. 详细日志测试 (ssh -vvv):"
          ssh -vvv \
              -o BatchMode=yes \
              -o ConnectTimeout=5 \
              -i ~/.ssh/test_key \
              ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} "echo '详细测试'" 2>&1 | grep -A5 -B5 "libcrypto\|publickey" || true
          
          # 选项3: 使用不同密钥算法
          echo -e "\n3. 指定密钥算法:"
          ssh -o PubkeyAcceptedAlgorithms=+ssh-rsa \
              -o HostKeyAlgorithms=+ssh-rsa \
              -o BatchMode=yes \
              -i ~/.ssh/test_key \
              ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} "echo '算法测试'" 2>&1 | tail -10 || true
          
          # 选项4: 尝试转换密钥格式
          echo -e "\n4. 转换密钥格式测试:"
          cp ~/.ssh/test_key ~/.ssh/test_key_orig
          ssh-keygen -p -m PEM -f ~/.ssh/test_key_orig -N "" 2>&1 | grep -v "Enter" || echo "转换尝试完成"
          
          if [ -f ~/.ssh/test_key_orig ]; then
            ssh -i ~/.ssh/test_key_orig \
                -o BatchMode=yes \
                ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} "echo '转换后测试'" 2>&1 | tail -5 || true
          fi
          
      - name: Test with Python SSH Library (替代方案)
        run: |
          echo "=== 使用 Python paramiko 测试 ==="
          python3 -c "
          import paramiko
          import os
          
          key_content = '''${{ secrets.GOOD_KITTY_PRIVATE_KEY }}'''
          
          # 写入临时文件
          with open('/tmp/test_ssh_key', 'w') as f:
              f.write(key_content)
          os.chmod('/tmp/test_ssh_key', 0o600)
          
          try:
              # 尝试加载密钥
              key = paramiko.RSAKey.from_private_key_file('/tmp/test_ssh_key')
              print('✅ RSA 密钥加载成功')
          except:
              try:
                  key = paramiko.Ed25519Key.from_private_key_file('/tmp/test_ssh_key')
                  print('✅ Ed25519 密钥加载成功')
              except:
                  try:
                      key = paramiko.ECDSAKey.from_private_key_file('/tmp/test_ssh_key')
                      print('✅ ECDSA 密钥加载成功')
                  except Exception as e:
                      print(f'❌ 所有密钥格式尝试失败: {e}')
          
          # 清理
          os.remove('/tmp/test_ssh_key')
          "
          
      - name: Generate New Test Key
        run: |
          echo "=== 生成新的测试密钥对 ==="
          mkdir -p /tmp/ssh_test
          cd /tmp/ssh_test
          
          # 生成不同格式的密钥
          echo "1. 生成 RSA 4096 密钥:"
          ssh-keygen -t rsa -b 4096 -f test_rsa -N "" -q
          echo "公钥指纹:"
          ssh-keygen -l -f test_rsa
          
          echo -e "\n2. 生成 Ed25519 密钥:"
          ssh-keygen -t ed25519 -f test_ed25519 -N "" -q
          echo "公钥指纹:"
          ssh-keygen -l -f test_ed25519
          
          echo -e "\n=== 显示生成的密钥格式 ==="
          echo "RSA 密钥头部:"
          head -2 test_rsa
          echo -e "\nEd25519 密钥头部:"
          head -2 test_ed25519
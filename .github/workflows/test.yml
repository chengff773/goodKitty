name: test secrets
on: workflow_dispatch

env:
    SSH_PRIVATE_KEY_CONTENT: ${{ secrets.GOOD_KITTY_PRIVATE_KEY }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Show Secrets (for debugging)
        run: |
          echo "SSH_USER: ${{ secrets.GOOD_KITTY_SSH_USER }}"
          echo "SSH_HOST: ${{ secrets.GOOD_KITTY_SSH_HOST }}"
          # 不显示私钥，因为太长
          echo "SSH_PRIVATE_KEY is set: ${{ secrets.GOOD_KITTY_PRIVATE_KEY != '' }}"

      - name: Debug SSH Key Content
        run: |
          # 写入密钥文件
          echo "${{ secrets.GOOD_KITTY_PRIVATE_KEY }}" > test_key
          chmod 600 test_key
          
          # 检查文件内容
          echo "=== File size ==="
          wc -c test_key
          echo "=== First 3 lines ==="
          head -3 test_key
          echo "=== Last 3 lines ==="
          tail -3 test_key
          
          # 检查密钥格式
          echo "=== Key format check ==="
          if head -1 test_key | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "✅ 密钥格式看起来正确"
          else
            echo "❌ 密钥格式可能有问题"
          fi
          
          # 测试密钥解析
          echo "=== Testing key with ssh-keygen ==="
          ssh-keygen -l -f test_key 2>&1 || echo "❌ 密钥解析失败"
          
          # 清理
          rm test_key

      - name: test SSH connection
        run: |
          # 配置私钥
          mkdir -p /home/runner/.ssh
          echo "${{ secrets.GOOD_KITTY }}" > /home/runner/.ssh/deploy_key

          # 配置&检查目录权限
          chmod 600 /home/runner/.ssh/deploy_key
          ls -la /home/runner/.ssh/
          chmod 700 /home/runner/.ssh/
          ls -la /home/runner/.ssh/deploy_key
          echo "权限: $(stat -c %a /home/runner/.ssh/deploy_key)"

          echo "服务器：${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }}"

          ssh -i /home/runner/.ssh/deploy_key \
            ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} \
            "echo test" || echo "❌ SSH 连接失败"

          # # 开启 SSH 详细日志（-vvv），测试连接
          # ssh -vvv -i /home/runner/.ssh/deploy_key \
          #   -o StrictHostKeyChecking=no \
          #   -o UserKnownHostsFile=/dev/null \
          #   ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} \
          #   "echo 'SSH 连接成功'"
name: test secrets
on: workflow_dispatch

env:
    SSH_PRIVATE_KEY_CONTENT: ${{ secrets.GOOD_KITTY_PRIVATE_KEY }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Show Secrets (for debugging)
        run: |
          echo "SSH_USER: ${{ secrets.GOOD_KITTY_SSH_USER }}"
          echo "SSH_HOST: ${{ secrets.GOOD_KITTY_SSH_HOST }}"
          # 不显示私钥，因为太长
          echo "SSH_PRIVATE_KEY is set: ${{ secrets.GOOD_KITTY_PRIVATE_KEY != '' }}"

      - name: Debug SSH Key Content
        run: |
          # 写入密钥文件
          echo "${{ secrets.GOOD_KITTY_PRIVATE_KEY }}" > test_key
          chmod 600 test_key
          
          # 检查文件内容
          echo "=== File size ==="
          wc -c test_key
          echo "=== First 3 lines ==="
          head -3 test_key
          echo "=== Last 3 lines ==="
          tail -3 test_key
          
          # 检查密钥格式
          echo "=== Key format check ==="
          if head -1 test_key | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "✅ 密钥格式看起来正确"
          else
            echo "❌ 密钥格式可能有问题"
          fi
          
          # 测试密钥解析
          echo "=== Testing key with ssh-keygen ==="
          ssh-keygen -l -f test_key 2>&1 || echo "❌ 密钥解析失败"
          
          # 清理
          rm test_key
      
      - name: Check Key Format Details
        run: |
          echo "=== 详细检查密钥格式 ==="
          
          # 写入密钥
          KEY_CONTENT="${{ secrets.GOOD_KITTY_PRIVATE_KEY }}"
          echo "$KEY_CONTENT" > /tmp/test.key
          
          echo "1. 文件行数: $(wc -l < /tmp/test.key)"
          echo "2. 文件大小: $(wc -c < /tmp/test.key) 字节"
          
          echo -e "\n3. 文件内容结构:"
          echo "前10个字符: $(head -c 10 /tmp/test.key)"
          echo "最后10个字符: $(tail -c 10 /tmp/test.key)"
          
          echo -e "\n4. 检查开始和结束标记:"
          if head -1 /tmp/test.key | grep -q "BEGIN"; then
            echo "✅ 第一行包含 BEGIN"
          else
            echo "❌ 第一行不包含 BEGIN"
            echo "第一行内容: '$(head -1 /tmp/test.key)'"
          fi
          
          if tail -1 /tmp/test.key | grep -q "END"; then
            echo "✅ 最后一行包含 END"
          else
            echo "❌ 最后一行不包含 END"
            echo "最后一行内容: '$(tail -1 /tmp/test.key)'"
          fi
          
          echo -e "\n5. 显示首尾各3行:"
          echo "--- 开始 ---"
          head -3 /tmp/test.key
          echo "--- 结束 ---"
          tail -3 /tmp/test.key
          
          echo -e "\n6. 检查换行符类型:"
          od -c /tmp/test.key | head -20 | grep -E "\\n|\\r"
          
          # 清理
          rm /tmp/test.key

      - name: test SSH connection
        run: |
          # 配置私钥
          mkdir -p /home/runner/.ssh
          echo "${{ secrets.GOOD_KITTY }}" > /home/runner/.ssh/deploy_key

          # 配置&检查目录权限
          chmod 600 /home/runner/.ssh/deploy_key
          ls -la /home/runner/.ssh/
          chmod 700 /home/runner/.ssh/
          ls -la /home/runner/.ssh/deploy_key
          echo "权限: $(stat -c %a /home/runner/.ssh/deploy_key)"

          # 添加主机密钥到 known_hosts
          ssh-keyscan -H 8.141.119.102 >> ~/.ssh/known_hosts
          ssh -i /home/runner/.ssh/deploy_key root@8.141.119.102
            # ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} \
            "echo test" || echo "❌ SSH 连接失败"

          # # 开启 SSH 详细日志（-vvv），测试连接
          # ssh -vvv -i /home/runner/.ssh/deploy_key \
          #   -o StrictHostKeyChecking=no \
          #   -o UserKnownHostsFile=/dev/null \
          #   ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} \
          #   "echo 'SSH 连接成功'"
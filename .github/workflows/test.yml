name: test secrets
on: workflow_dispatch

env:
    SSH_PRIVATE_KEY_CONTENT: ${{ secrets.GOOD_KITTY_PRIVATE_KEY }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Show Secrets (for debugging)
        run: |
          echo "SSH_USER: ${{ secrets.GOOD_KITTY_SSH_USER }}"
          echo "SSH_HOST: ${{ secrets.GOOD_KITTY_SSH_HOST }}"
          # 不显示私钥，因为太长
          echo "SSH_PRIVATE_KEY is set: ${{ secrets.GOOD_KITTY_PRIVATE_KEY != '' }}"

      - name: Debug SSH Key Content
        run: |
          # 写入密钥文件
          echo "${{ secrets.GOOD_KITTY_PRIVATE_KEY }}" > test_key
          chmod 600 test_key
          
          # 检查文件内容
          echo "=== File size ==="
          wc -c test_key
          echo "=== First 3 lines ==="
          head -3 test_key
          echo "=== Last 3 lines ==="
          tail -3 test_key
          
          # 检查密钥格式
          echo "=== Key format check ==="
          if head -1 test_key | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "✅ 密钥格式看起来正确"
          else
            echo "❌ 密钥格式可能有问题"
          fi
          
          # 测试密钥解析
          echo "=== Testing key with ssh-keygen ==="
          ssh-keygen -l -f test_key 2>&1 || echo "❌ 密钥解析失败"
          
          # 清理
          rm test_key
      
      - name: Check Key Format Details
        run: |
          echo "=== 详细检查密钥格式 ==="
          
          # 写入密钥
          KEY_CONTENT="${{ secrets.GOOD_KITTY_PRIVATE_KEY }}"
          echo "$KEY_CONTENT" > /tmp/test.key
          
          echo "1. 文件行数: $(wc -l < /tmp/test.key)"
          echo "2. 文件大小: $(wc -c < /tmp/test.key) 字节"
          
          echo -e "\n3. 文件内容结构:"
          echo "前10个字符: $(head -c 10 /tmp/test.key)"
          echo "最后10个字符: $(tail -c 10 /tmp/test.key)"
          
          echo -e "\n4. 检查开始和结束标记:"
          if head -1 /tmp/test.key | grep -q "BEGIN"; then
            echo "✅ 第一行包含 BEGIN"
          else
            echo "❌ 第一行不包含 BEGIN"
            echo "第一行内容: '$(head -1 /tmp/test.key)'"
          fi
          
          if tail -1 /tmp/test.key | grep -q "END"; then
            echo "✅ 最后一行包含 END"
          else
            echo "❌ 最后一行不包含 END"
            echo "最后一行内容: '$(tail -1 /tmp/test.key)'"
          fi
          
          echo -e "\n5. 显示首尾各3行:"
          echo "--- 开始 ---"
          head -3 /tmp/test.key
          echo "--- 结束 ---"
          tail -3 /tmp/test.key
          
          echo -e "\n6. 检查换行符类型:"
          od -c /tmp/test.key | head -20 | grep -E "\\n|\\r"
          
          # 清理
          rm /tmp/test.key

      - name: Deep Key Analysis
        run: |
          echo "=== 完整密钥内容分析 ==="
          
          # 写入密钥
          echo "${{ secrets.GOOD_KITTY_PRIVATE_KEY }}" > /tmp/analysis.key
          
          echo "1. 显示完整内容（编码显示特殊字符）:"
          cat -A /tmp/analysis.key
          
          echo -e "\n2. 逐行分析:"
          line_num=1
          while IFS= read -r line; do
            echo "第 ${line_num} 行: 长度=${#line}, 内容开头='${line:0:20}'"
            ((line_num++))
          done < /tmp/analysis.key
          
          echo -e "\n3. 检查标记完整性:"
          first_line=$(head -1 /tmp/analysis.key)
          last_line=$(tail -1 /tmp/analysis.key)
          
          echo "第一行: '$first_line'"
          echo "最后一行: '$last_line'"
          
          if [[ "$first_line" == "-----BEGIN OPENSSH PRIVATE KEY-----" ]]; then
            echo "✅ BEGIN标记完整"
          elif [[ "$first_line" == "-----BEGIN "* ]]; then
            echo "⚠️  BEGIN标记不标准: $first_line"
          else
            echo "❌ BEGIN标记异常"
          fi
          
          echo -e "\n4. Base64内容检查:"
          # 提取中间的Base64内容
          sed '1d;$d' /tmp/analysis.key > /tmp/base64.txt
          echo "Base64行数: $(wc -l < /tmp/base64.txt)"
          echo "Base64总长度: $(wc -c < /tmp/base64.txt)"
          
          # 尝试解码测试
          if base64 -d /tmp/base64.txt > /tmp/decoded 2>/dev/null; then
            echo "✅ Base64可以正常解码"
            echo "解码后大小: $(wc -c < /tmp/decoded) 字节"
          else
            echo "❌ Base64解码失败"
          fi
          
          # 清理
          rm -f /tmp/analysis.key /tmp/base64.txt /tmp/decoded

      - name: Test SSH Key Functionality
        run: |
          echo "=== 测试密钥功能 ==="

          # 1. 写入密钥
          mkdir -p /home/runner/.ssh
          chmod 700 /home/runner/.ssh
          echo "${{ secrets.GOOD_KITTY_PRIVATE_KEY }}" > ~/.ssh/test_key
          chmod 600 ~/.ssh/test_key
          
          echo "1. 检查密钥指纹:"
          ssh-keygen -l -f ~/.ssh/test_key
          
          echo -e "\n2. 生成公钥测试:"
          # 从私钥生成公钥
          ssh-keygen -y -f ~/.ssh/test_key > ~/.ssh/test_key.pub 2>&1 || echo "生成公钥失败"
          
          if [ -f ~/.ssh/test_key.pub ]; then
            echo "生成的公钥内容:"
            cat ~/.ssh/test_key.pub
          fi
          
          echo -e "\n3. 测试密钥与服务器的兼容性:"
          # 尝试不同的SSH选项
          SSH_OPTIONS=(
            ""
            "-o PubkeyAcceptedAlgorithms=+ssh-rsa"
            "-o HostKeyAlgorithms=+ssh-rsa"
            "-o KexAlgorithms=diffie-hellman-group-exchange-sha256"
          )
          
          for opts in "${SSH_OPTIONS[@]}"; do
            echo -e "\n尝试选项: $opts"
            timeout 10 ssh $opts \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=5 \
              -o BatchMode=yes \
              -o LogLevel=ERROR \
              -i ~/.ssh/test_key \
              ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} \
              "echo '连接成功'" 2>&1 | head -5 || true
          done
          
          echo -e "\n4. 详细调试输出（关键）:"
          ssh -vvv \
              -o BatchMode=yes \
              -o ConnectTimeout=5 \
              -i ~/.ssh/test_key \
              ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} \
              "exit" 2>&1 | grep -A10 -B5 "libcrypto\|Offering public key\|Authentication refused\|no mutual signature algorithm"

      - name: test SSH connection
        run: |
          # 配置私钥
          # mkdir -p /home/runner/.ssh
          echo "${{ secrets.GOOD_KITTY_PRIVATE_KEY }}" > /home/runner/.ssh/deploy_key

          # 配置&检查目录权限
          chmod 600 /home/runner/.ssh/deploy_key
          ls -la /home/runner/.ssh/
          chmod 700 /home/runner/.ssh/
          ls -la /home/runner/.ssh/deploy_key
          echo "权限: $(stat -c %a /home/runner/.ssh/deploy_key)"

          # 添加主机密钥到 known_hosts
          ssh-keyscan -H 8.141.119.102 >> ~/.ssh/known_hosts
          ssh -i /home/runner/.ssh/deploy_key root@8.141.119.102
            # ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} \
            "echo test" || echo "❌ SSH 连接失败"

          # # 开启 SSH 详细日志（-vvv），测试连接
          # ssh -vvv -i /home/runner/.ssh/deploy_key \
          #   -o StrictHostKeyChecking=no \
          #   -o UserKnownHostsFile=/dev/null \
          #   ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} \
          #   "echo 'SSH 连接成功'"
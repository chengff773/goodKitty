name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_DIR: './my-app'
  DEPLOY_DIR: '/usr/share/nginx/html/good-kitty'
  RSYNC_STDOUT: "/var/log/rsync/good-kitty/rsync.log" # ç”¨äºè°ƒè¯•çš„æ—¥å¿—æ–‡ä»¶
  SSH_PRIVATE_KEY: ${{ secrets.GOOD_KITTY_PRIVATE_KEY }}

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # å®‰è£…pnpm
      - uses: pnpm/action-setup@v2
        with:
          version: 10.13.1

      # å®‰è£…node
      - uses: actions/setup-node@v4
        with:
          node-version: 22.17.1
          cache: 'pnpm'
          cache-dependency-path: '${{ env.PROJECT_DIR }}/pnpm-lock.yaml'

      # å®‰è£…ä¾èµ–
      - name: Install dependencies (pnpm)
        working-directory: ${{ env.PROJECT_DIR }}
        run: pnpm install --frozen-lockfile
      
      # æ„å»º
      - name: Build project
        working-directory: ${{ env.PROJECT_DIR }}
        run: pnpm run build
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: ${{ env.PROJECT_DIR }}/dist/

  deploy:
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main'  # åªæœ‰ main åˆ†æ”¯ push æ—¶æ‰éƒ¨ç½²
    environment: production  # å…³è”ç”Ÿäº§ç¯å¢ƒ

    steps:
      # ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./deploy-dist  # ä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•

      # é…ç½® SSH å¯†é’¥
      - name: Setup SSH Key Properly
        run: |
          mkdir -p /home/runner/.ssh
          echo "${{ secrets.GOOD_KITTY_PRIVATE_KEY }}" > /home/runner/.ssh/deploy_key
          # é…ç½®&æ£€æŸ¥ç›®å½•æƒé™
          chmod 600 /home/runner/.ssh/deploy_key
          ls -la /home/runner/.ssh/
          chmod 700 /home/runner/.ssh/
          ls -la /home/runner/.ssh/deploy_key
          # æ·»åŠ ä¸»æœºå¯†é’¥åˆ° known_hosts
          ssh-keyscan -H "${{ secrets.GOOD_KITTY_SSH_HOST }}" >> ~/.ssh/known_hosts

      # éƒ¨ç½²å‰ç½®æ ¡éªŒè„šæœ¬
      - name: Run pre-deployment script
        run: |
          ssh -T -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} << 'EOF'
            echo "=== å¼€å§‹éƒ¨ç½² good-kitty ==="
            echo "æ—¶é—´: $(date)"
            echo "æäº¤: ${{ github.sha }}"
            echo "éƒ¨ç½²ç›®å½•: ${{ env.DEPLOY_DIR }}"
            
            # ç¡®ä¿ç›®å½•å­˜åœ¨
            mkdir -p ${{ env.DEPLOY_DIR }}
            echo "é¢„éƒ¨ç½²å‡†å¤‡å®Œæˆ"
          EOF

      - name: Deploy files via rsync directly
        run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./deploy-dist/ \
            ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }}:${{ env.DEPLOY_DIR }}
          
          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"
          
          # è®¾ç½®æƒé™
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.GOOD_KITTY_SSH_USER }}@${{ secrets.GOOD_KITTY_SSH_HOST }} \
            "sudo chown -R nginx:nginx ${{ env.DEPLOY_DIR }} && echo 'æƒé™è®¾ç½®æˆåŠŸ'"
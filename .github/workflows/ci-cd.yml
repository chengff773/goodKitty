name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_DIR: './my-app'
  DEPLOY_DIR: '/usr/share/nginx/html/good-kitty'
  RSYNC_STDOUT: "/var/log/rsync/good-kitty.log" # 用于调试的日志文件

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 安装pnpm
      - uses: pnpm/action-setup@v2
        with:
          version: 10.13.1

      # 安装node
      - uses: actions/setup-node@v4
        with:
          node-version: 22.17.1
          cache: 'pnpm'
          cache-dependency-path: '${{ env.PROJECT_DIR }}/pnpm-lock.yaml'

      # 安装依赖
      - name: Install dependencies (pnpm)
        working-directory: ${{ env.PROJECT_DIR }}
        run: pnpm install --frozen-lockfile
      
      # 构建
      - name: Build project
        working-directory: ${{ env.PROJECT_DIR }}
        run: pnpm run build
      
      # 上传构建产物
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: ${{ env.PROJECT_DIR }}/dist/

  deploy:
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main'  # 只有 main 分支 push 时才部署
    environment: production  # 关联生产环境

    steps:
      # 下载构建产物
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./deploy-dist  # 下载到临时目录

      # 配置 SSH 密钥
      - name: Setup SSH Key Properly
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # 创建正确的密钥文件
          echo "${{ secrets.GOOD_KITTY_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      # 部署到服务器
      - name: Deploy to server
        uses: easingthemes/ssh-deploy@v4
        with:
          SSH_PRIVATE_KEY: ${{ secrets.GOOD_KITTY_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.GOOD_KITTY_SSH_HOST }}
          REMOTE_USER: ${{ secrets.GOOD_KITTY_SSH_USER }}
          TARGET: ${{ env.DEPLOY_DIR }}
          SOURCE: ./deploy-dist/
          SSH_CMD_ARGS: "-i ~/.ssh/deploy_key"

          # 部署脚本
          SCRIPT_BEFORE: |
            echo "=== 开始部署 good-kitty ==="
            echo "时间: $(date)"
            echo "提交: ${{ github.sha }}"
            echo "部署目录: ${{ env.DEPLOY_DIR }}"
            
            # 确保目录存在
            mkdir -p ${{ env.DEPLOY_DIR }}
            
          SCRIPT_AFTER: |
            echo "=== 部署完成 ==="
            
            # 设置文件权限（重要！）
            echo "设置文件权限..."
            sudo chown -R nginx:nginx ${{ env.DEPLOY_DIR }} || true
            sudo chmod -R 755 ${{env.DEPLOY_DIR}} || true
            
            echo "检查部署结果:"
            ls -la ${{ env.DEPLOY_DIR }}/ | head -10